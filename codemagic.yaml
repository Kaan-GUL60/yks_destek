workflows:
  my-workflow:
    name: iOS Build (Telefon ve Web icin)
    instance_type: mac_mini_m1
    environment:
      flutter: stable
      xcode: latest
      cocoapods: default

    scripts:
      - name: GoogleService-Info.plist'i Xcode'a Ekle (Windows Fix)
        script: |
          gem install xcodeproj
          ruby -e '
            require "xcodeproj"
            project_path = "ios/Runner.xcodeproj"
            project = Xcodeproj::Project.open(project_path)
            file_name = "GoogleService-Info.plist"
            unless project.main_group["Runner"].files.any? { |f| f.path == file_name }
              file_ref = project.main_group["Runner"].new_file(file_name)
              project.targets.first.add_resources([file_ref])
              project.save
            end
          '

      - name: Paketleri Getir
        script: |
          flutter pub get
          cd ios
          pod install
          cd ..

      # 1️⃣ ÖNCE: iOS Simulator (Web / Emulator için ZIP)
      - name: iOS Simulator Build (ZIP)
        script: |
          flutter build ios --debug --simulator
          cd build/ios/iphonesimulator
          zip -r Runner-simulator.zip Runner.app

      # 2️⃣ SONRA: Gerçek Cihaz (IPA)
      - name: iPhone icin IPA Build
        script: |
          flutter build ipa --release --no-codesign

    artifacts:
      - build/ios/iphonesimulator/Runner-simulator.zip
      - build/ios/ipa/*.ipa
      - flutter_drive.log
